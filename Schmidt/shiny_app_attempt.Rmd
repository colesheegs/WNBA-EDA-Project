---
title: "R Shiny App"
author: "Belle Schmidt"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    theme: 
      version: 4
      bootswatch: sandstone
---

About
==========================


### **Additional Information:** 

**Authors:**

Belle Schmidt, Liam Jennings, and Cole Siniawski


**Objective:**

Although we outlined a few questions, our shiny app gives viewers the flexibility to look at many different questions regarding the WNBA. We hope that viewers may be able to learn more about the best teams and players and be able to find similarities and differences between the best and the worst.


**Tribulations and Victories of Data Acquisition and Wrangling:**




**Color Scheme:**




### **Defining The Variables**

```{r global, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(flexdashboard)
#library(shinydashboard)
library(shiny)
library(bslib)
library(patchwork)
theme_set(theme_bw())
wnba_shots <- read_csv("https://raw.githubusercontent.com/36-SURE/36-SURE.github.io/main/data/wnba_shots.csv")

#View(wnba_shots)
```


```{r, echo = FALSE}
# Removed The All Star Game & Added New Variables
wnba_shots <- wnba_shots |>
  filter(shooting_team != "Team Stewart" & shooting_team != "Team Wilson") |> 
   mutate(shooting_player = ifelse(
      str_detect(desc, "blocks") == TRUE,
      sub(".*?\\b(?:blocks)\\W+(\\w+(?:\\W+\\w+){0,2})\\b(?:'s| 's| B. 's)\\s.*", "\\1", desc, perl = TRUE), sub("\\ makes.*|\\ misses.*|\\ B. makes.*|\\ B. misses.*", "\\1", desc)),
         score_differential = home_score - away_score, 
         free_throw = if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 3 of"), 3,
       if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 2 of"), 2,
               if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 1 of") | str_detect(shot_type, "[Tt]echnical"), 1, 0))),
       made_shot = if_else(made_shot == "TRUE", "Made", "Missed"),
       Shooting_Team_Home_Away = if_else(shooting_team == home_team_name, "Home", "Away"),
    coordinate_x = abs(coordinate_x),
    # rename shooting_team to include team name
    shooting_team = case_match(
      shooting_team,
      "Atlanta" ~ "Atlanta Dream",
      "Chicago" ~ "Chicago Sky",
      "Connecticut" ~ "Connecticut Sun",
      "Dallas" ~ "Dallas Wings",
      "Indiana" ~ "Indiana Fever",
      "Las Vegas" ~ "Las Vegas Aces",
      "Los Angeles" ~ "Los Angeles Spark",
      "Minnesota" ~ "Minnesota Lynx",
      "New York" ~ "New York Liberty",
      "Phoenix" ~ "Phoenix Mercury",
      "Seattle" ~ "Seattle Storm",
      "Washington" ~ "Washington Mystics"
    ),
    home_team_name = case_match(
      home_team_name,
      "Atlanta" ~ "Atlanta Dream",
      "Chicago" ~ "Chicago Sky",
      "Connecticut" ~ "Connecticut Sun",
      "Dallas" ~ "Dallas Wings",
      "Indiana" ~ "Indiana Fever",
      "Las Vegas" ~ "Las Vegas Aces",
      "Los Angeles" ~ "Los Angeles Spark",
      "Minnesota" ~ "Minnesota Lynx",
      "New York" ~ "New York Liberty",
      "Phoenix" ~ "Phoenix Mercury",
      "Seattle" ~ "Seattle Storm",
      "Washington" ~ "Washington Mystics"),
    away_team_name = case_match(
      away_team_name,
      "Atlanta" ~ "Atlanta Dream",
      "Chicago" ~ "Chicago Sky",
      "Connecticut" ~ "Connecticut Sun",
      "Dallas" ~ "Dallas Wings",
      "Indiana" ~ "Indiana Fever",
      "Las Vegas" ~ "Las Vegas Aces",
      "Los Angeles" ~ "Los Angeles Spark",
      "Minnesota" ~ "Minnesota Lynx",
      "New York" ~ "New York Liberty",
      "Phoenix" ~ "Phoenix Mercury",
      "Seattle" ~ "Seattle Storm",
      "Washington" ~ "Washington Mystics"))

  
  

#View(wnba_shots)
```

```{r, echo = FALSE}
# Shots taken in the last 30 seconds of the fourth quarter Where the score differential was less than 6 after the shot was taken
end_of_game_shots <- wnba_shots |>
  filter(game_seconds_remaining <= 30 & score_differential %in% c(-6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6) & qtr == 4) 

# All Close Games
all_close_games <- end_of_game_shots|> 
  distinct(game_id) 

# All Shots Taken In Last 30 Seconds 
all_shots <- wnba_shots|>
  filter(game_seconds_remaining <= 30 & qtr == 4) 
  
# All Shots Taken In Last 30 Seconds In Close Games
all_close_game_shots <- left_join(all_close_games, all_shots) |> 
  mutate(made_shot = factor(made_shot,levels = c("Missed", "Made"))) 


# The earliest time within the last 30 seconds where a shot occurred for a close game
close_games <- end_of_game_shots |> 
  group_by(game_id) |> 
  slice_max(game_seconds_remaining) |> 
  arrange(-free_throw) |> 
  slice_head() |> 
  select(game_id, home_team_name, away_team_name, score_differential) 


# The score after the last shot of every game 
final_score <- wnba_shots |> 
  group_by(game_id) |> 
  slice_min(game_seconds_remaining) |> 
  arrange(free_throw) |> 
  slice_head() |> 
   rename(final_score_differential = score_differential) |> 
   select(game_id, final_score_differential) 

# Score Change From First Shot In Last 30 Seconds To Last Shot of Game & Final Outcomes Added
close_games_observing <- left_join(close_games, final_score) |> 
  mutate(home_team_outcome =  
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential == final_score_differential, "Won - Kept Same Lead",
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential > final_score_differential, "Won - Lead Decreased",
 if_else(score_differential > 0 & final_score_differential > 0, "Won - Extended Lead",
 if_else(score_differential > 0 & final_score_differential == 0, "Tied - Lost Lead", 
 if_else(score_differential > 0 & final_score_differential < 0, "Lost - Lost Lead", 
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential == final_score_differential, "Lost - No Comeback",
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential > final_score_differential, "Lost - Deficit Increased",
 if_else(score_differential < 0 & final_score_differential < 0 & final_score_differential > score_differential, "Lost - Deficit Decreased",
 if_else(score_differential < 0 & final_score_differential == 0, "Tied - Comeback",
 if_else(score_differential == 0 & final_score_differential == 0, "Tied - No Change",
 if_else(score_differential == 0 & final_score_differential > 0, "Won - From Tie",
 if_else(score_differential == 0 & final_score_differential < 0, "Lost - From Tie", 
         "Won - Took Lead From Loss")))))))))))),
 away_team_outcome =  
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential == final_score_differential, "Lost - No Comeback",
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential > final_score_differential, "Lost - Deficit Decreased",
 if_else(score_differential > 0 & final_score_differential > 0, "Lost - Deficit Increased",
 if_else(score_differential > 0 & final_score_differential == 0, "Tied - Comeback", 
 if_else(score_differential > 0 & final_score_differential < 0, "Won - Took Lead From Loss", 
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential == final_score_differential, "Won - Kept Same Lead",
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential > final_score_differential, "Won - Extended Lead",
 if_else(score_differential < 0 & final_score_differential < 0 & final_score_differential > score_differential, "Won - Lead Decreased",
 if_else(score_differential < 0 & final_score_differential == 0, "Tied - Lost Lead",
 if_else(score_differential == 0 & final_score_differential == 0, "Tied - No Change",
 if_else(score_differential == 0 & final_score_differential > 0, "Lost - From Tie",
 if_else(score_differential == 0 & final_score_differential < 0, "Won - From Tie", 
         "Lost - Lost Lead")))))))))))),
 Home_Result = if_else(str_detect(home_team_outcome, "^Won"), "Win",
                       if_else(str_detect(home_team_outcome, "^Lost"), "Loss", "Tie")),
         Away_Result = if_else(str_detect(away_team_outcome, "^Won"), "Win",
                       if_else(str_detect(away_team_outcome, "^Lost"), "Loss", "Tie")))|> 
  ungroup() |> 
  mutate(away_team_outcome = factor(away_team_outcome, levels = c("Lost - Lost Lead", "Lost - Deficit Increased", "Lost - No Comeback", "Lost - Deficit Decreased", "Lost - From Tie", "Tied - Lost Lead", "Tied - No Change", "Tied - Comeback", "Won - Lead Decreased", "Won - Kept Same Lead", "Won - Extended Lead", "Won - From Tie", "Won - Took Lead From Loss")),
         home_team_outcome =factor(home_team_outcome, levels = c("Lost - Lost Lead", "Lost - Deficit Increased", "Lost - No Comeback", "Lost - Deficit Decreased", "Lost - From Tie", "Tied - Lost Lead", "Tied - No Change", "Tied - Comeback", "Won - Lead Decreased", "Won - Kept Same Lead", "Won - Extended Lead", "Won - From Tie", "Won - Took Lead From Loss")))


win_loss_color_vector <- c("Lost - Lost Lead" = "firebrick4", "Lost - Deficit Increased" = "firebrick", "Lost - No Comeback" = "firebrick3", "Lost - Deficit Decreased" = "firebrick2", "Lost - From Tie" = "firebrick1", "Tied - Lost Lead" = "darkorange1", "Tied - No Change" = "goldenrod1", "Tied - Comeback" = "gold", "Won - Lead Decreased" = "lightgreen", "Won - Kept Same Lead" = "green1", "Won - Extended Lead" = "green3", "Won - From Tie" = "green4", "Won - Took Lead From Loss" = "darkgreen")

```

League Performance In Close Home vs Away Games
==================================================

### Overarching Question 1 - How Does The League Overall Perform in Close Home Games Compared To Close Away Games?

Row
-------------------------------------

```{r, include=FALSE}
# Both Away And Home Win vs. Loss In League
win_losses <- close_games_observing |>
  pivot_longer(Home_Result:Away_Result,
               values_to = "win_or_loss",
               names_to = "home_or_away_result") |> 
  mutate(home_or_away_result = ifelse(home_or_away_result == "Home_Result", "Home", "Away"))
         
win_losses
```

```{r}
# Home vs. Away Outcomes 
league_win_vs_losses <- ggplot(win_losses, aes(x = home_or_away_result, fill = win_or_loss)) +
  geom_bar(position = position_fill()) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("firebrick", "goldenrod1", "green4")) +
  labs(title = "Outcomes For Home And Away Teams In Close Games",
       x = "Home vs. Away",
       fill = "Result") 


league_win_vs_losses
```


```{r}
  ggplot(all_close_game_shots, aes(x = Shooting_Team_Home_Away)) +
  geom_bar(aes(fill = made_shot), color = "black", position = "fill") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("white", "#E77500")) +
  labs(title = "Shooting Percentage For Home And Away Teams In Close Games",
       x = "Home vs. Away",
       fill = "Result") +
  theme(panel.background = element_rect(fill = "gray80"), panel.grid.minor = element_blank())
```

Performance in Close Home Games vs Close Away Games By Team
=============================================================

### Overarching Question 2 - How Do Each Of The Teams Perform In Close Home Compared To Close Away Games?


Inputs {.sidebar}
-------------------------
```{r, echo=FALSE}
win_losses2 <- close_games_observing |>
  pivot_longer(home_team_name:away_team_name,
               values_to = "teams",
               names_to = "home_or_away_team") |> 
  mutate(home_or_away_team = ifelse(home_or_away_team == "home_team_name", "Home", "Away"))

 inputPanel(
    checkboxGroupInput("teams_check", "Select Teams For Graph 1:",
                       choices = c("All", unique(as.character(win_losses2$teams))),                         
                       selected = "All")
  )
```


```{r, echo=FALSE}
# Adds Both Away And Home Win vs. losses

home_win_loss <- close_games_observing |> 
  group_by(home_team_name, Home_Result) |> 
  summarise(num_times_home = n()) |> 
  rename(team = home_team_name,
         result = Home_Result)

away_win_losses <- close_games_observing |> 
  group_by(away_team_name, Away_Result) |> 
  summarise(num_times_away = n()) |> 
  rename(team = away_team_name,
         result = Away_Result)

         
win_loss_per_team <- full_join(away_win_losses, home_win_loss) |> 
 mutate(num_times_home = replace_na(num_times_home, 0),
        num_times_away = replace_na(num_times_away, 0)) |> 
  pivot_longer(num_times_home:num_times_away,
               values_to = "occurences",
               names_to = "home_or_away") |> 
  mutate(home_or_away = ifelse(home_or_away == "num_times_home", "Home", "Away")) |> 
  ungroup()

#win_loss_per_team

  inputPanel(
    checkboxGroupInput("teams_check1", "Select Teams For Graph 2:",
                       choices = c("All", unique(as.character(win_loss_per_team$team))),                         
                       selected = "All")
  )
```

Row
-------------------------------------

```{r, echo=FALSE}


renderPlot({
    filtered_teams <- if("All" %in% input$teams_check) {
      win_losses2
    } else {
      win_losses2 |>
        filter(teams %in% input$teams_check)
    }

ggplot(filtered_teams, aes(x = fct_rev(fct_infreq(teams)), fill = home_or_away_team)) +
  geom_bar(color = "black") +
  coord_flip() + 
  scale_fill_manual(values = c("white", "#E77500")) +
  theme(panel.background = element_rect(fill = "gray80"), panel.grid.minor = element_blank()) +
  labs(title = "Number of Close Home And Away Games Per Team", 
       y = "Number of Close Games",
       x = "WNBA Team",
       subtitle = "Close games is defined as a score differential of 6 or less in the last 30 seconds",
       fill = "Home or Away") 
  })

```


```{r, echo=FALSE}
renderPlot({
    filtered_teams1 <- if("All" %in% input$teams_check1) {
      win_loss_per_team
    } else {
      win_loss_per_team |>
        filter(team %in% input$teams_check1)
    }

  ggplot(filtered_teams1, aes(x = home_or_away, y = occurences, fill = result)) +
  geom_bar(position = position_fill(), stat = "identity") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(values = c("firebrick", "goldenrod1", "green4")) +
  labs(title = "Outcomes For Home And Away Teams In Close Games",
       x = "Home vs. Away",
       fill = "Result") +
  facet_wrap(~team)
 })
```


Outcome Types in Close Home Games vs Close Away Games
============================================================= 

Inputs {.sidebar}
-------------------------

```{r, include=FALSE}

# Home Team Results By League
num_home_outcomes <- close_games_observing |>
  select(home_team_outcome, Home_Result) |> 
  count(home_team_outcome, Home_Result) |> 
  rename(num_times_home = n,
         outcome = home_team_outcome)

# Away Team Results By League
num_away_outcomes <- close_games_observing |>
  select(away_team_outcome, Away_Result) |> 
  count(away_team_outcome, Away_Result) |> 
  rename(num_times_away = n,
         outcome = away_team_outcome) 

#num_away_outcomes


# Number of Occurences of All Outcomes For Home vs. Away
possible_outcomes <- full_join(num_home_outcomes, num_away_outcomes, by = "outcome") |> 
  mutate(num_times_home = replace_na(num_times_home, 0),
         num_times_away = replace_na(num_times_away, 0),
         Win_Loss = ifelse(is.na(Away_Result), Home_Result, Away_Result)) |> 
  select(-Home_Result, -Away_Result)

#possible_outcomes
```


```{r, echo=FALSE}

# Home Team Results By Team 
home_game_results <- close_games_observing |> 
  group_by(home_team_name, home_team_outcome, Home_Result) |>
  summarise(num_times_home_per_team = n()) |> 
  rename(outcome = home_team_outcome) |> 
  ungroup()
#home_game_results


inputPanel(
 selectInput("teams1", label = "Home Team Graph:", 
             choices = c("Atlanta Dream" = "Atlanta Dream",
                         "Chicago Sky" = "Chicago Sky",
                         "Connecticut Sun" = "Connecticut Sun",
                         "Dallas Wings" = "Dallas Wings",
                         "Indiana Fever" = "Indiana Fever",
                         "Las Vegas Aces" = "Las Vegas Aces",
                         "Los Angeles Spark" = "Los Angeles Saprk",
                         "Minnesota Lynx" = "Minnesota Lynx",
                         "Phoenix Mercury" = "Phoenix Mercury",
                         "Seattle Storm" = "Seattle Storm",
                         "Washington Mystics" = "Washington Mystics",
                         "New York Liberty" = "New York Liberty"))
)

```

```{r, echo=FALSE}
# Away Game Results By Team
away_game_results <- close_games_observing |> 
  group_by(away_team_name, away_team_outcome, Away_Result) |> 
  summarise(times_occured_away_per_team = n()) |> 
  rename(outcome = away_team_outcome) |> 
  ungroup()

#away_game_results

inputPanel(
 selectInput("teams2", label = "Away Team Graph:", 
             choices = c("Atlanta Dream" = "Atlanta Dream",
                         "Chicago Sky" = "Chicago Sky",
                         "Connecticut Sun" = "Connecticut Sun",
                         "Dallas Wings" = "Dallas Wings",
                         "Indiana Fever" = "Indiana Fever",
                         "Las Vegas Aces" = "Las Vegas Aces",
                         "Los Angeles Spark" = "Los Angeles Saprk",
                         "Minnesota Lynx" = "Minnesota Lynx",
                         "Phoenix Mercury" = "Phoenix Mercury",
                         "Seattle Storm" = "Seattle Storm",
                         "Washington Mystics" = "Washington Mystics",
                         "New York Liberty" = "New York Liberty"))
)
```

Row
-------------------------------------  

```{r}
# Home Outcome Types Occured Across Leagues In Close Games

home_outcomes <- ggplot(possible_outcomes, aes(x = Win_Loss, y = num_times_home, fill = outcome)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Occurences of Each Outcome Type For Home Teams",
       y = "Occurences",
       fill = "Outcome") +
  scale_fill_manual(values = win_loss_color_vector) +
  theme(axis.title.x = element_blank()) 



# Away Outcome Types Occured Across Leagues In Close Games
away_outcomes <- ggplot(possible_outcomes, aes(x = Win_Loss, y = num_times_away, fill = outcome)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Occurences of Each Outcome Type For Away Teams",
       y = "Occurences",
       fill = "Outcome") +
  scale_fill_manual(values = win_loss_color_vector)+
  theme(axis.title.x = element_blank()) 


away_outcomes + home_outcomes +
  plot_layout(guides = "collect", nrow = 2) +
  labs("Occurences Of Each Outcome Type For Both Home and Away Teams In Close Games")
```



```{r, echo=FALSE}

renderPlot({
    # Plot for home outcomes
    filtered_teams2 <- if("All" %in% input$teams1) {
      home_game_results
    } else {
      home_game_results |>
        filter(home_team_name %in% input$teams1)
    }
    
    Team_home_outcomes <- ggplot(filtered_teams2, aes(x = Home_Result, y = num_times_home_per_team, fill = outcome)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "Occurences of Each Outcome When The Home Team",
           y = "Occurences",
           fill = "Outcome") +
      scale_fill_manual(values = win_loss_color_vector) +
      theme(axis.title.x = element_blank()) 

    # Plot for away outcomes
    filtered_teams3 <- if("All" %in% input$teams2) {
      away_game_results
    } else {
      away_game_results |>
        filter(away_team_name %in% input$teams2)
    }

    Team_away_outcomes <- ggplot(filtered_teams3, aes(x = Away_Result, y = times_occured_away_per_team, fill = outcome)) +
      geom_bar(stat = "identity", position = "dodge") +
      labs(title = "Occurences of Each Outcome Type When The Away Team",
           y = "Occurences",
           fill = "Outcome") +
      scale_fill_manual(values = win_loss_color_vector) +
      theme(axis.title.x = element_blank()) 

    Team_home_outcomes + Team_away_outcomes +
  plot_layout(guides = "collect", nrow = 2)
})
```

