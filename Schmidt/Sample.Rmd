---
title: "WNBA Eda Project - Belle Schmidt"
output: html_document
date: "2024-06-06"
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
wnba_shots <- read_csv("https://raw.githubusercontent.com/36-SURE/36-SURE.github.io/main/data/wnba_shots.csv")

#View(wnba_shots)
```


# Removed The All Star Game & Added Shooter Variable
```{r, include=FALSE}
wnba_shots <- wnba_shots |>
  filter(shooting_team != "Team Stewart" & shooting_team != "Team Wilson") |> 
  mutate(shooter_first_name = word(desc, 1),
         shooter_last_name = word(desc, 2),
         shooter = paste(shooter_first_name, shooter_last_name),
         score_differential = home_score - away_score, 
         free_throw = if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 3 of"), 3,
       if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 2 of"), 2,
               if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 1 of") | str_detect(shot_type, "[Tt]echnical"), 1, 0))),
       made_shot = if_else(made_shot == "TRUE", "Made", "Missed"),
       Shooting_Team_Home_Away = if_else(shooting_team == home_team_name, "Home", "Away"))|>  
 select(! c(shooter_first_name, shooter_last_name)) 
  

#View(wnba_shots)
```

# Shooting in the last 2 minutes of the Second Quarter

```{r, include=FALSE}
wnba_shots |>
  filter(qtr == 2 & quarter_seconds_remaining <= 120.0) |>
  arrange(quarter_seconds_remaining)
```


# Shooting in the last 2 minutes of the Fourth Quarter
```{r, include=FALSE}
wnba_shots |>
  filter(qtr == 4 & quarter_seconds_remaining <= 120.0) |>
  arrange(quarter_seconds_remaining)
```

# Last Thirty Seconds In 4th Quarter

## Games With Close Scores (6 points or less) At Some Point In The Last 30 Seconds
```{r, include=FALSE}
# Shots taken in the last 30 seconds of the fourth quarter Where the score differential was less than 6 after the shot was taken
end_of_game_shots <- wnba_shots |>
  filter(game_seconds_remaining <= 30 & score_differential %in% c(-6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6) & qtr == 4) 

# All Close Games
all_close_games <- end_of_game_shots|> 
  distinct(game_id)


# All Shots Taken In Last 30 Seconds 
all_shots <- wnba_shots|>
  filter(game_seconds_remaining <= 30 & qtr == 4) 
  
# All Shots Taken In Last 30 Seconds In Close Games
all_close_game_shots <- left_join(all_close_games, all_shots) |> 
  mutate(Home_Or_Away)


# The earliest time where a shot occurred for a close game
close_games <- end_of_game_shots |> 
  group_by(game_id) |> 
  slice_max(game_seconds_remaining) |> 
  arrange(-free_throw) |> 
  slice_head() |> 
  select(game_id, home_team_name, away_team_name, score_differential) 


# The score after the last shot of the every game 
final_score <- wnba_shots |> 
  group_by(game_id) |> 
  slice_min(game_seconds_remaining) |> 
  arrange(free_throw) |> 
  slice_head() |> 
   rename(final_score_differential = score_differential) |> 
   select(game_id, final_score_differential) 

# Score Change From First Shot In Last 30 Seconds To Last Shot of Game & Final Outcomes
close_games_observing <- left_join(close_games, final_score) |> 
  mutate(home_team_outcome =  
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential == final_score_differential, "Won - Kept Same Lead",
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential > final_score_differential, "Won - Lead Decreased",
 if_else(score_differential > 0 & final_score_differential > 0, "Won - Extended Lead",
 if_else(score_differential > 0 & final_score_differential == 0, "Tied - Lost Lead", 
 if_else(score_differential > 0 & final_score_differential < 0, "Lost - Lost Lead", 
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential == final_score_differential, "Lost - No Comeback",
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential > final_score_differential, "Lost - Deficit Increased",
 if_else(score_differential < 0 & final_score_differential < 0 & final_score_differential > score_differential, "Lost - Deficit Decreased",
 if_else(score_differential < 0 & final_score_differential == 0, "Tied - Comeback",
 if_else(score_differential == 0 & final_score_differential == 0, "Tied - No Change",
 if_else(score_differential == 0 & final_score_differential > 0, "Won - From Tie",
 if_else(score_differential == 0 & final_score_differential < 0, "Lost - From Tie", 
         "Won - Took Lead From Loss")))))))))))),
 away_team_outcome =  
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential == final_score_differential, "Lost - No Comeback",
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential > final_score_differential, "Lost - Deficit Decreased",
 if_else(score_differential > 0 & final_score_differential > 0, "Lost - Deficit Increased",
 if_else(score_differential > 0 & final_score_differential == 0, "Tied - Comeback", 
 if_else(score_differential > 0 & final_score_differential < 0, "Won - Took Lead From Loss", 
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential == final_score_differential, "Won - Kept Same Lead",
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential > final_score_differential, "Won - Extended Lead",
 if_else(score_differential < 0 & final_score_differential < 0 & final_score_differential > score_differential, "Won - Lead Decreased",
 if_else(score_differential < 0 & final_score_differential == 0, "Tied - Lost Lead",
 if_else(score_differential == 0 & final_score_differential == 0, "Tied - No Change",
 if_else(score_differential == 0 & final_score_differential > 0, "Lost - From Tie",
 if_else(score_differential == 0 & final_score_differential < 0, "Won - From Tie", 
         "Lost - Lost Lead")))))))))))),
 Home_Result = if_else(str_detect(home_team_outcome, "^Won"), "Win",
                       if_else(str_detect(home_team_outcome, "^Lost"), "Loss", "Tie")),
         Away_Result = if_else(str_detect(away_team_outcome, "^Won"), "Win",
                       if_else(str_detect(away_team_outcome, "^Lost"), "Loss", "Tie")))


close_games_observing <- close_games_observing |> 
  ungroup() |> 
  mutate(away_team_outcome = factor(close_games_observing$away_team_outcome, levels = c("Lost - Lost Lead", "Lost - Deficit Increased", "Lost - No Comeback", "Lost - Deficit Decreased", "Lost - From Tie", "Tied - Lost Lead", "Tied - No Change", "Tied - Comeback", "Won - Lead Decreased", "Won - Kept Same Lead", "Won - Extended Lead", "Won - From Tie", "Won - Took Lead From Loss")),
         home_team_outcome =factor(close_games_observing$home_team_outcome, levels = c("Lost - Lost Lead", "Lost - Deficit Increased", "Lost - No Comeback", "Lost - Deficit Decreased", "Lost - From Tie", "Tied - Lost Lead", "Tied - No Change", "Tied - Comeback", "Won - Lead Decreased", "Won - Kept Same Lead", "Won - Extended Lead", "Won - From Tie", "Won - Took Lead From Loss"))) 

close_games_observing
```

# Overarching Question 1 - How Does The League Overall Perform in Close Home Compared To Close Away Games?

## Outcomes Occured Across Leagues In Close Games
```{r, include=FALSE}
# Adds Both Away And Home Win vs. losses
win_losses <- close_games_observing |>
  pivot_longer(Home_Result:Away_Result,
               values_to = "win_or_loss",
               names_to = "home_or_away")
```

```{r}
# Home vs. Away Outcomes
win_vs_losses <- ggplot(win_losses, aes(x = home_or_away)) +
  geom_bar(aes(fill = win_or_loss)) +
  scale_fill_manual(values = c("firebrick", "goldenrod1", "green4")) +
  labs(title = "Outcomes For Home And Away Teams In Close Games",
       x = "Home vs. Away",
       fill = "Result") 
 # geom_label(aes(label = sta), position = position_stack(vjust = 0.5))

win_vs_losses
```
Plot Description: From this plot we can determine that in a close game, the away team is more likely to win than the home team. 

## Outcomes Related To Home and Away
```{r, include=FALSE}

# Home Team Results By Team 
home_game_results <- close_games_observing |> 
  group_by(home_team_name, home_team_outcome, Home_Result) |>
  summarise(num_times_home_per_team = n()) |> 
  rename(team_name = home_team_name) 

 #home_game_results

# Home Team Results By League
num_home_outcomes <- close_games_observing |>
  select(home_team_outcome, Home_Result) |> 
  count(home_team_outcome, Home_Result) |> 
  rename(num_times_home = n,
         outcome = home_team_outcome)

num_home_outcomes

# Away Game Results By Team
away_game_results <- close_games_observing |> 
  group_by(away_team_name, away_team_outcome, Away_Result) |> 
  summarise(times_occured_per_team = n()) |> 
  rename(team_name = away_team_name) 


#away_game_results

# Away Team Results By League
num_away_outcomes <- close_games_observing |>
  select(away_team_outcome, Away_Result) |> 
  count(away_team_outcome, Away_Result) |> 
  rename(num_times_away = n,
         outcome = away_team_outcome) 

num_away_outcomes


# Number of Occurences of All Outcomes For Home vs. Away
possible_outcomes <- full_join(num_home_outcomes, num_away_outcomes, by = "outcome") |> 
  mutate(num_times_home = replace_na(num_times_home, 0),
         num_times_away = replace_na(num_times_away, 0),
         Win_Loss = ifelse(is.na(Away_Result), Home_Result, Away_Result)) |> 
  select(-Home_Result, -Away_Result)

 possible_outcomes
```

```{r}
# Home Outcome Types Occured Across Leagues In Close Games

home_outcomes <- ggplot(possible_outcomes, aes(x = Win_Loss, y = num_times_home, fill = outcome)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Occurences of Each Outcome Type For Home Teams In Close Games",
       y = "Occurences",
       fill = "Outcome") +
  scale_fill_manual(values = c("firebrick4", "firebrick", "firebrick3", "firebrick2", "firebrick1", "darkorange1", "goldenrod1", "gold", "lightgreen", "green1","green3", "green4", "darkgreen")) +
  theme(axis.title.x = element_blank()) 



# Away Outcome Types Occured Across Leagues In Close Games
away_outcomes <- ggplot(possible_outcomes, aes(x = Win_Loss, y = num_times_away, fill = outcome)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Occurences of Each Outcome Type For Away Teams In Close Games",
       y = "Occurences",
       fill = "Outcome") +
  scale_fill_manual(values = c("firebrick4", "firebrick", "firebrick3", "firebrick2", "firebrick1", "darkorange1", "goldenrod1", "gold", "lightgreen", "green1","green3", "green4", "darkgreen"))+
  theme(axis.title.x = element_blank()) 

# Combined Graph of Away vs Home Team Outcomes; Point Out Away Teams Win More In Close Games
library(patchwork)

away_outcomes + home_outcomes +
  plot_layout(guides = "collect", nrow = 2) +
  labs("Occurences Of Each Outcome Type For Both Home and Away Teams")
```


**Plot Description:** From the *Occurences Of Each Outcome Type For Both Home and Away Teams* graph, we can learn that in close games, the team that won (regardless of if they were home or away) most likely extended their lead between the time of the first shot in the last 30 seconds and the end of the game. This corresponds with the idea that the team that lost, most likely lost with a higher deficit than what they were down after the first shot in the last 30 seconds of the game. For games that ended the 4th quarter with a tie, however, it is most likely that a team had the lead after the first shot in the last 30 seconds but then the other team tied it up. There were slightly more occurrences of the away team having the lead and losing it, however, it is hard to predict if home or away is a predictor because there were only a handful of occurrences.

## League Shooting Percentage Home vs. Away 
```{r}
win_losses

win_vs_losses <- ggplot(win_losses, aes(x = home_or_away)) +
  geom_bar(aes(fill = win_or_loss)) +
  scale_fill_manual(values = c("firebrick", "goldenrod1", "green4")) +
  labs(title = "Outcomes For Home And Away Teams In Close Games",
       x = "Home vs. Away",
       fill = "Result") 
 # geom_label(aes(label = sta), position = position_stack(vjust = 0.5))

win_vs_losses

all_close_game_shots 

all_close_game_shots |> 
  group_by(shot_type, made_shot) |> 
  summarise(num_shots = n()) |>
  ggplot(aes(x = home_or_away, made_shot)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.9)) +
  scale_fill_manual(values = c("white", "#E77500"))
  
```





# Overarching Question 2 - How Do Each Of The Teams Perform In Close Home Compared To Close Away Games?

## Each Team's Win vs. Loss (Home and Away)

## Each Team's Outcome Type When Home vs. Away

## Each Team's Shooting Percentage Home vs. Away
```{r}
away_game_results |> 
  filter(team_name == "Atlanta") |> 
  ggplot(aes(x = win_or_loss, y = times_occured, fill = away_team_outcome)) +
  geom_bar(stat = "identity", position = "dodge") 

# +
#   facet_wrap(~team_name, nrow = 4)

```


# Overarching Question - How does time left in the game impact each team's performance? 

## Teams Who Shot Best In Close Games (30 Seconds)
```{r, include=FALSE}
shots_made_data1 <- end_of_game_shots |>
   mutate(made_shot = if_else(made_shot == "TRUE", "Made", "Missed")) 



 shots_made_data <- end_of_game_shots |>
   mutate(made_shot = if_else(made_shot == "TRUE", 1, 0)) |>
   filter(made_shot == 1) |>
   group_by(shooting_team) |>
   summarise(shots_made = n())

 shots_taken_data <- end_of_game_shots |>
   group_by(shooting_team) |>
   summarise(shots_taken = n())

 temp_data <- left_join(shots_taken_data, shots_made_data)

 temp_data[is.na(temp_data)] <- 0

 shooting_percentage <- temp_data |>
   mutate(shot_percentage = round(shots_made / shots_taken, 3),
          total_shots = shots_taken + shots_made)

 shooting_percentage
```

## Number of Close Games (6 points or less with 30 seconds left) Per Team

```{r}
ggplot(num_games, aes(x = fct_rev(fct_infreq(shooting_team)), fill = shooting_team)) +
  geom_bar() +
  coord_flip() + 
  scale_fill_manual(values = c("#C8102E", "#418FDE", "#643335", "#C4D600", "#FFCD00", "#000000", "#702F8A", "#236192", "#003DA5","#CB6015","#2C5234", "#0C2340")) +
  labs(title = "Number of Close Games Per Team", 
       y = "Number of Close Games",
       x = "WNBA Team",
       subtitle = "Close games is defined as a score differential of 6 or less in the last 30 seconds") +
  theme(legend.position = "none")
  
  
```

## Graph For Number of WNBA Teams In Final 30 Seconds of Close Games

```{r}
shots_made_data1 |> 
  ggplot(aes(x = fct_rev(fct_infreq(shooting_team)), fill = made_shot))  +
  geom_bar(color = "black") +
  theme(axis.text.x=element_text(angle=45, hjust=0.9)) +
  scale_fill_manual(values = c("#E77500", "white")) +
  coord_flip() +
  labs(title = "Shots Made vs. Missed Per WNBA Team",
       x = "WNBA Team",
       y = "Number of Shots"
       )
  
```


## Graph For Shooting Percentage of WNBA Teams In Final 30 Seconds of Close Games

```{r}
shooting_percentage |> 
  ggplot(aes(x = reorder(shooting_team, shot_percentage), y = shot_percentage, fill = shooting_team)) +
  geom_bar(stat = "identity") +
   scale_fill_manual(values = c("#C8102E", "#418FDE", "#643335", "#C4D600", "#FFCD00", "#000000", "#702F8A", "#236192", "#003DA5","#CB6015","#2C5234", "#0C2340")) +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, hjust=0.9)) +
  coord_flip() 
```

# Final Possession

## Games With Close Scores (3 points or less) Down To The Final Possession
```{r}
final_possession <- wnba_shots |> 
  group_by(game_id) |> 
  slice_max(game_play_number) |> 
  filter(score_differential %in% c(-3, -2, -1, 0, 1, 2, 3))

final_possession
```

## Number of Times Home Team In Close Game 
```{r}
home_team_in_close_games <- final_possession |> 
  group_by(game_id) |> 
  slice_head() |> 
  group_by(home_team_name) |> 
  summarise(num_times_home = n()) |> 
  rename(team_name = home_team_name)

home_team_in_close_games
```

## Number of Times Away Team In Close Game 
```{r}
away_team_in_close_games <- final_possession |> 
  group_by(game_id) |> 
  slice_head() |> 
  group_by(away_team_name) |> 
  summarise(num_times_away = n()) |> 
  rename(team_name = away_team_name)

away_team_in_close_games
```


```{r}
close_game_appereances <- full_join(away_team_in_close_games, home_team_in_close_games)



close_game_appereances[is.na(close_game_appereances)] <- 0

close_game_appearances <- close_game_appereances |> 
  mutate(num_close_games = num_times_away + num_times_home)

close_game_appearances
```


## Number of Games That Came Down To Final Possession Per Team 
```{r}
ggplot(close_game_appearances, aes(x = reorder(team_name, num_close_games), y = num_close_games, fill = team_name)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("#C8102E", "#418FDE", "#643335", "#C4D600", "#FFCD00", "#000000", "#702F8A", "#236192", "#003DA5","#CB6015","#2C5234", "#0C2340")) +
  coord_flip()
```

## Number of Home vs. Away Games That Came Down To Final Possession Per Team 
```{r}

close_game_appearances2 <- close_game_appearances |> 
  select(!num_close_games)

library(reshape2)
df_long <- melt(close_game_appearances2)

df_long

ggplot(df_long, aes(x = team_name, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.9)) +
  scale_fill_manual(values = c("white", "#E77500"))

```

## Teams Who Shot Best In Close Games That Came Down To The Final Possession
```{r}
final_shots_made_data <- final_possession |>
  mutate(made_shot = if_else(made_shot == "TRUE", 1, 0)) |> 
  filter(made_shot == 1) |> 
  group_by(shooting_team) |> 
  summarise(shots_made = n())

final_shots_taken_data <- final_possession |>
  group_by(shooting_team) |> 
  summarise(shots_taken = n()) 
 
temp_data_2 <- left_join(final_shots_taken_data, final_shots_made_data)

temp_data_2[is.na(temp_data_2)] <- 0

final_shooting_percentage <- temp_data_2 |> 
  mutate(shot_percentage = round(shots_made / shots_taken, 3))  

final_shooting_percentage
```


## Number of Shots That Came Down To Final Possession Per Team (Does Not Include Teams With 0)

```{r}
ggplot(final_possession, aes(x = fct_rev(fct_infreq(shooting_team)), fill = shooting_team)) +
  geom_bar() +
  coord_flip() +
  scale_fill_manual(values = c("#C8102E", "#418FDE", "#C4D600", "#FFCD00", "#702F8A",  "#003DA5","#CB6015", "#2C5234", "#0C2340"  )) 
  # scale_color_manual(values = c("#418FDE", "#FFCD00", "#0C2340", "#041E42", "#FFC72C", "#FF671F", "#201747", "#FBE122", "#C8102E"))
```
