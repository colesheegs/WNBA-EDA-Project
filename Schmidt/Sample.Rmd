---
title: "WNBA Eda Project - Belle Schmidt"
output: html_document
date: "2024-06-06"
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
wnba_shots <- read_csv("https://raw.githubusercontent.com/36-SURE/36-SURE.github.io/main/data/wnba_shots.csv")

#View(wnba_shots)
```


# Removed The All Star Game & Added Shooter Variable
```{r}
wnba_shots <- wnba_shots |>
  filter(shooting_team != "Team Stewart" & shooting_team != "Team Wilson") |> 
  mutate(shooter_first_name = word(desc, 1),
         shooter_last_name = word(desc, 2),
         shooter = paste(shooter_first_name, shooter_last_name),
         score_differential = home_score - away_score, 
         free_throw = if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 3 of"), 3,
       if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 2 of"), 2,
               if_else(str_detect(shot_type, "[Ff]ree [Tt]hrow - 1 of") | str_detect(shot_type, "[Tt]echnical"), 1, 0)))) |>
  select(! c(shooter_first_name, shooter_last_name)) 

#View(wnba_shots)
```


# Overarching Question - How does time left in the game impact each team's performance? 


## Shooting in the last 2 minutes of the Second Quarter

```{r}
wnba_shots |>
  filter(qtr == 2 & quarter_seconds_remaining <= 120.0) |>
  arrange(quarter_seconds_remaining)
```


## Shooting in the last 2 minutes of the Fourth Quarter
```{r}
wnba_shots |>
  filter(qtr == 4 & quarter_seconds_remaining <= 120.0) |>
  arrange(quarter_seconds_remaining)
```

# Last Thirty Seconds

## Games With Close Scores (6 points or less) At Some Point In The Last 30 Seconds
```{r}
# End of game shots where the score differential was less than 6 after the shot was taken
end_of_game_shots <- wnba_shots |>
  filter(game_seconds_remaining <= 30 & score_differential %in% c(-6, -5, -4, -3, -2, -1, 0, 1, 2, 3, 4, 5, 6)) 


# Games That Had A Close Score At Some Point Within the last 30 seconds; The highest time where a shot occurred
close_games <- end_of_game_shots |> 
  group_by(game_id) |> 
  slice_max(game_seconds_remaining) |> 
  arrange(-free_throw) |> 
  slice_head() |>
  select(game_id, home_team_name, away_team_name, score_differential)


# The last shot of the every game 
final_score <- wnba_shots |> 
  group_by(game_id) |> 
  slice_min(game_seconds_remaining) |> 
  arrange(free_throw) |> 
  slice_head() |> 
  rename(final_score_differential = score_differential) |> 
  select(game_id, final_score_differential)

# Score Change From First Shot In Last 30 Seconds Where Score is 
close_games_observing <- left_join(close_games, final_score) |> 
  mutate(home_team_outcome =  
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential == final_score_differential, "Kept Same Lead",
 if_else(score_differential > 0 & final_score_differential > 0 & score_differential > final_score_differential, "Kept Lead - Decreased",
 if_else(score_differential > 0 & final_score_differential > 0, "Kept Lead - Increased",
 if_else(score_differential > 0 & final_score_differential <= 0, "Lost Lead", 
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential == final_score_differential, "No Comeback",
 if_else(score_differential < 0 & final_score_differential < 0 & score_differential < final_score_differential, "Comeback - Not Enough",
 if_else(score_differential < 0 & final_score_differential < 0 & final_score_differential < score_differential, "No Comeback - Deficity Increased",
 if_else(score_differential > 0 & final_score_differential <= 0, "Lost Lead","Took Lead")))))))))

close_games_observing






```


## Teams Who Shot Best In Close Games (30 Seconds)
```{r}
shots_made_data1 <- end_of_game_shots |>
   mutate(made_shot = if_else(made_shot == "TRUE", "Made", "Missed")) 

 shots_made_data1

 shots_made_data <- end_of_game_shots |>
   mutate(made_shot = if_else(made_shot == "TRUE", 1, 0)) |>
   filter(made_shot == 1) |>
   group_by(shooting_team) |>
   summarise(shots_made = n())

 shots_made_data

 shots_taken_data <- end_of_game_shots |>
   group_by(shooting_team) |>
   summarise(shots_taken = n())

 temp_data <- left_join(shots_taken_data, shots_made_data)

 temp_data[is.na(temp_data)] <- 0

 shooting_percentage <- temp_data |>
   mutate(shot_percentage = round(shots_made / shots_taken, 3),
          total_shots = shots_taken + shots_made)

 shooting_percentage
```

## Number of Close Games (6 points or less with 30 seconds left) Per Team

```{r}
ggplot(num_games, aes(x = fct_rev(fct_infreq(shooting_team)), fill = shooting_team)) +
  geom_bar() +
  coord_flip() + 
  scale_fill_manual(values = c("#C8102E", "#418FDE", "#643335", "#C4D600", "#FFCD00", "#000000", "#702F8A", "#236192", "#003DA5","#CB6015","#2C5234", "#0C2340")) +
  labs(title = "Number of Close Games Per Team", 
       y = "Number of Close Games",
       x = "WNBA Team",
       subtitle = "Close games is defined as a score differential of 6 or less in the last 30 seconds") +
  theme(legend.position = "none")
  
  
```

## Graph For Number of WNBA Teams In Final 30 Seconds of Close Games

```{r}
shots_made_data1 |> 
  ggplot(aes(x = fct_rev(fct_infreq(shooting_team)), fill = made_shot))  +
  geom_bar(color = "black") +
  theme(axis.text.x=element_text(angle=45, hjust=0.9)) +
  scale_fill_manual(values = c("#E77500", "white")) +
  coord_flip() +
  labs(title = "Shots Made vs. Missed Per WNBA Team",
       x = "WNBA Team",
       y = "Number of Shots"
       )
  
```


## Graph For Shooting Percentage of WNBA Teams In Final 30 Seconds of Close Games

```{r}
shooting_percentage |> 
  ggplot(aes(x = reorder(shooting_team, shot_percentage), y = shot_percentage, fill = shooting_team)) +
  geom_bar(stat = "identity") +
   scale_fill_manual(values = c("#C8102E", "#418FDE", "#643335", "#C4D600", "#FFCD00", "#000000", "#702F8A", "#236192", "#003DA5","#CB6015","#2C5234", "#0C2340")) +
  theme_bw() +
  theme(axis.text.x=element_text(angle=45, hjust=0.9)) +
  coord_flip() 
```

# Final Possession

## Games With Close Scores (3 points or less) Down To The Final Possession
```{r}
final_possession <- wnba_shots |> 
  group_by(game_id) |> 
  slice_max(game_play_number) |> 
  filter(score_differential %in% c(-3, -2, -1, 0, 1, 2, 3))

final_possession
```

## Number of Times Home Team In Close Game 
```{r}
home_team_in_close_games <- final_possession |> 
  group_by(game_id) |> 
  slice_head() |> 
  group_by(home_team_name) |> 
  summarise(num_times_home = n()) |> 
  rename(team_name = home_team_name)

home_team_in_close_games
```

## Number of Times Away Team In Close Game 
```{r}
away_team_in_close_games <- final_possession |> 
  group_by(game_id) |> 
  slice_head() |> 
  group_by(away_team_name) |> 
  summarise(num_times_away = n()) |> 
  rename(team_name = away_team_name)

away_team_in_close_games
```


```{r}
close_game_appereances <- full_join(away_team_in_close_games, home_team_in_close_games)



close_game_appereances[is.na(close_game_appereances)] <- 0

close_game_appearances <- close_game_appereances |> 
  mutate(num_close_games = num_times_away + num_times_home)

close_game_appearances
```


## Number of Games That Came Down To Final Possession Per Team 
```{r}
ggplot(close_game_appearances, aes(x = reorder(team_name, num_close_games), y = num_close_games, fill = team_name)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("#C8102E", "#418FDE", "#643335", "#C4D600", "#FFCD00", "#000000", "#702F8A", "#236192", "#003DA5","#CB6015","#2C5234", "#0C2340")) +
  coord_flip()
```

## Number of Home vs. Away Games That Came Down To Final Possession Per Team 
```{r}

close_game_appearances2 <- close_game_appearances |> 
  select(!num_close_games)

library(reshape2)
df_long <- melt(close_game_appearances2)

df_long

library(ggplot2)

ggplot(df_long, aes(x = team_name, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge", color = "black") +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.9)) +
  scale_fill_manual(values = c("white", "#E77500"))

```

## Teams Who Shot Best In Close Games That Came Down To The Final Possession
```{r}
final_shots_made_data <- final_possession |>
  mutate(made_shot = if_else(made_shot == "TRUE", 1, 0)) |> 
  filter(made_shot == 1) |> 
  group_by(shooting_team) |> 
  summarise(shots_made = n())

final_shots_taken_data <- final_possession |>
  group_by(shooting_team) |> 
  summarise(shots_taken = n()) 
 
temp_data_2 <- left_join(final_shots_taken_data, final_shots_made_data)

temp_data_2[is.na(temp_data_2)] <- 0

final_shooting_percentage <- temp_data_2 |> 
  mutate(shot_percentage = round(shots_made / shots_taken, 3))  

final_shooting_percentage
```


## Number of Shots That Came Down To Final Possession Per Team (Does Not Include Teams With 0)

```{r}
ggplot(final_possession, aes(x = fct_rev(fct_infreq(shooting_team)), fill = shooting_team)) +
  geom_bar() +
  coord_flip() +
  scale_fill_manual(values = c("#C8102E", "#418FDE", "#C4D600", "#FFCD00", "#702F8A",  "#003DA5","#CB6015", "#2C5234", "#0C2340"  )) 
  # scale_color_manual(values = c("#418FDE", "#FFCD00", "#0C2340", "#041E42", "#FFC72C", "#FF671F", "#201747", "#FBE122", "#C8102E"))
```
