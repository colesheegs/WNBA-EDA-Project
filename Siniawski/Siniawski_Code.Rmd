---
title: "WNBA EDA Project"
output: html_document
date: "2024-06-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(wehoop)
library(sportyR)
library(paletteer)
```



```{r}
wnba_pbp <- load_wnba_pbp(2023)
wnba_shots <- wnba_pbp |> 
  filter(shooting_play) |> 
  # make a column to indicate the shooting team
  mutate(shooting_team = ifelse(team_id == home_team_id, 
                                home_team_name,
                                away_team_name)) |> 
  select(game_id, game_play_number, game_type = season_type,
         desc = text, shot_type = type_text, 
         made_shot = scoring_play, shot_value = score_value, 
         coordinate_x, coordinate_y, shooting_team, 
         home_team_name, away_team_name, home_score, away_score, qtr,
         quarter_seconds_remaining = start_quarter_seconds_remaining,
         game_seconds_remaining = start_game_seconds_remaining)

shot_chart <- wnba_shotchartdetail()

shot_chart <- shot_chart$Shot_Chart_Detail
```



```{r}
wnba_shots |>   
  group_by(shooting_team) |> 
  summarise(total_shot_value = sum(shot_value)) |> 
  filter(total_shot_value >= 1000) |> 
  mutate(shooting_team = fct_reorder(shooting_team, total_shot_value)) |> 
  ggplot(aes(y = shooting_team, x = total_shot_value)) +
  geom_col(aes(fill = shooting_team)) +
  theme_bw() + 
  geom_label(aes(label = total_shot_value), size = 3) + 
  labs(
    title = "New York and Vegas Scoring More",
    x = "Total Shot Values", 
    y = "Teams",
    fill = "Teams",
    caption = "Data Courtesy of Wehoop"
  ) + 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "bold"))
```






```{r}
wnba_shots2 <- wnba_shots |> 
  filter(shooting_team %in% c("Seattle", "Chicago", "Washington", "Atlanta", "Minnesota", "Indiana", "Los Angeles", "Connecticut", "Dallas", "Phoenix", "New York", "Las Vegas")) |> 
  mutate(made_shot = ifelse(made_shot == "TRUE", 1, 0))

wnba_shots2 <- wnba_shots2[!grepl('Free Throw', wnba_shots2$shot_type),]

wnba_shots2 |> 
  group_by(shooting_team) |> 
  summarise(freq = n(),
    total_shots_made = sum(made_shot)) |> 
  mutate(prop = round(total_shots_made / freq, 3),
    shooting_team = fct_reorder(shooting_team, prop)) |>
  ggplot(aes(y = shooting_team, x = prop)) +
  geom_col(aes(fill = shooting_team)) +
  theme_bw() +
  geom_label(aes(label = prop), size = 2.5) +
  labs(
    title = "Vegas Racks Up the Points",
    x = "Proportion",
    y = "Teams",
    fill = "Teams",
    caption = "Data Courtesy of Wehoop"
  ) + 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "bold"))
```



```{r}
wnba_shots2 |> 
  filter(game_type == 3) |> 
  group_by(shooting_team) |> 
  summarise(freq = n(),
    total_shots_made = sum(made_shot)) |> 
  mutate(prop = round(total_shots_made / freq, 3),
    shooting_team = fct_reorder(shooting_team, prop)) |>
  ggplot(aes(y = shooting_team, x = prop)) +
  geom_col(aes(fill = shooting_team)) +
  theme_bw() +
  geom_label(aes(label = prop), size = 2.5) +
  labs(
    title = "Vegas Banking Points in the Playoffs Too",
    x = "Proportion",
    y = "Teams",
    fill = "Teams",
    caption = "Data Courtesy of Wehoop"
  ) + 
  theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.position = "none",
        plot.title = element_text(hjust = 0.5, face = "bold"))
```



```{r}
wnba_shots2 <- 
  wnba_shots2 |> 
  mutate(shooter_first = word(desc, 1),
         shooter_last = word(desc, 2), 
         shooter = paste(shooter_first, shooter_last))
# str_extract(procedure_text, "[A-Z][a-z]+ [0-9]+ [A-Z]+")
# str_extract_all(desc,'^(\\S+?)_(\\S+?)_')
# str_extract(desc, "\\s{2}"
# str_extract(species_location, "[^_]+_[^_]+")
```



```{r}
playoff1 <- wnba_shots2 |> 
  select(game_type, desc, made_shot, shooter, shooter_last, shooter_first) |> 
  filter(game_type == 3) |> 
  group_by(shooter, shooter_last) |> 
  summarise(freq = n(),
    total_shots_made = sum(made_shot)) |> 
  mutate(prop = round(total_shots_made / freq, 3)) |> 
  filter(freq >= 30, prop > 0.5) |> 
  arrange(desc(prop))
  

playoff1 |> 
  ggplot(aes(y = reorder(shooter, prop), x = prop)) +
  geom_col(fill = "orange1") +
  theme_bw() +
  geom_label(aes(label = prop), size = 2.5, label.size = 0.5) +
  # geom_text(aes(label = shooter_last), size = 3, hjust = 2, check_overlap = TRUE) +
  labs(
    title = "Alysha Clark and A'ja Wilson Clutch Up in Playoffs",
    x = "Proportion",
    y = "Player",
    caption = "Data Courtesy of Wehoop"
  ) +
  theme(plot.title = element_text(hjust = -2, face= "bold"))
  
```



```{r}
playoff2 <- wnba_shots2 |> 
  select(game_type, desc, made_shot, shooter, shooter_last, shooter_first) |> 
  filter(game_type == 3) |> 
  group_by(shooter, shooter_last) |> 
  summarise(freq = n(),
    total_shots_made = sum(made_shot)) |> 
  mutate(prop = round(total_shots_made / freq, 3)) |> 
  filter(freq >= 30, prop < 0.5) |> 
  arrange(desc(prop))

playoff2 |> 
  ggplot(aes(y = reorder(shooter, -prop), x = prop)) +
  geom_col(fill = "orange1") +
  theme_bw() +
  geom_label(aes(label = prop), size = 2.5, label.size = 0.5) +
  # geom_text(aes(label = shooter_last), size = 3, hjust = 2, check_overlap = TRUE) +
  labs(
    title = "Marine Johannes and Cheyenne Parker Don't Rise to the Occasion",
    x = "Proportion",
    y = "Player",
    caption = "Data Courtesy of Wehoop"
  )  +
  theme(plot.title = element_text(hjust = 1, face= "bold"))
  
```



```{r}
# Clustering
set.seed(10)

# creating new dataset
cluster_playoff <- wnba_shots2 |> 
  select(game_type, desc, made_shot, shooter, shooter_last, shooter_first) |> 
  filter(game_type == 3) |> 
  group_by(shooter) |> 
  summarise(freq = n(),
    total_shots_made = sum(made_shot)) |> 
  mutate(prop = round(total_shots_made / freq, 3))
  
# normalizing the data
cluster_playoff <- cluster_playoff |> 
  mutate(
    std_shot_made = as.numeric(scale(total_shots_made, center = TRUE, scale = TRUE)),
    std_shots = as.numeric(scale(freq, center = TRUE, scale = TRUE))
  )

std_kmeans <- cluster_playoff |> 
  select(std_shot_made, std_shots) |> 
  kmeans(algorithm = "Lloyd", centers = 4, nstart = 30)

cluster_playoff |>
  mutate(
    player_clusters = as.factor(std_kmeans$cluster)
  ) |>
  ggplot(aes(x = std_shot_made, y = std_shots,
             color = player_clusters)) +
  geom_point(size = 2, alpha = 0.5) + 
  ggthemes::scale_color_colorblind() +
  theme(legend.position = "bottom") +
  coord_fixed() +
  labs(
    x = "Total Shots Made",
    y = "Shots Attempted",
    color = "Player Clusters",
    title = "Player Impact in Playoffs",
    caption = "Data Courtesy of Wehoop"
  ) +
   theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face= "bold")
  )

```



```{r}
# Clustering
set.seed(10)

# creating new dataset
cluster_playoff2 <- wnba_shots2 |> 
  select(game_type, desc, made_shot, shot_value, shooter, shooter_last, shooter_first) |> 
  filter(game_type == 3) |> 
  group_by(shooter) |> 
  summarise(freq = n(),
    total_shots_made = sum(made_shot),
    total_points = sum(shot_value)) |> 
  mutate(prop = round(total_shots_made / freq, 3))
  
# normalizing the data
cluster_playoff2 <- cluster_playoff2 |> 
  mutate(
    std_points = as.numeric(scale(total_points, center = TRUE, scale = TRUE)),
    std_freq = as.numeric(scale(freq, center = TRUE, scale = TRUE))
  )

std_kmeans2 <- cluster_playoff2 |> 
  select(std_points, std_freq) |> 
  kmeans(algorithm = "Lloyd", centers = 4, nstart = 30)

cluster_playoff2 |>
  mutate(
    player_clusters = as.factor(std_kmeans$cluster)
  ) |>
  ggplot(aes(x = std_points, y = std_freq,
             color = player_clusters)) +
  geom_point(size = 2, alpha = 0.5) + 
  ggthemes::scale_color_colorblind() +
  theme(legend.position = "bottom") +
  coord_fixed() +
  labs(
    x = "Total Points",
    y = "Shots Attempted",
    color = "Player Clusters",
    title = "Player Impact in Playoffs",
    caption = "Data Courtesy of Wehoop"
  ) +
   theme(
    legend.position = "bottom",
    plot.title = element_text(hjust = 0.5, face= "bold")
  )
```




```{r}
# Geom hex for a potential heat map
wnba_shots2 |> 
  ggplot(aes(x = coordinate_x, y = coordinate_y)) +
  geom_hex(bins = 40) + 
  paletteer::scale_fill_paletteer_c("viridis::plasma")
```



```{r}
# Probably dont need this

# wnba_shots2 |> 
#   filter(game_type == 3) |> 
#   group_by(shooting_team) |> 
#   summarise(total_shot_value = sum(shot_value)) |> 
#   mutate(shooting_team = fct_reorder(shooting_team, total_shot_value)) |> 
#   ggplot(aes(x = shooting_team, y = total_shot_value)) +
#   geom_col(aes(fill = shooting_team)) +
#   theme_bw() + 
#   geom_label(aes(label = total_shot_value), size = 3) + 
#   geom_text(aes(label = shooting_team), size = 3, vjust = 5, check_overlap = TRUE) +
#   labs(
#     title = "New York and Vegas Scoring More",
#     x = "Teams", 
#     y = "Total Shot Values",
#     fill = "Teams",
#     caption = "Data Courtesy of Wehoop"
#   ) + 
#   theme(axis.text.x=element_blank(),
#         axis.ticks.x=element_blank())
```

